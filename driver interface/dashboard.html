<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Driver Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        /* Custom font-family for consistency */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for alternating rows in earnings modal for better readability */
        .ride-entry-card:nth-child(odd) {
            background-color: #f9fafb; /* Lighter background for odd rows */
        }
        .ride-entry-card {
            border-bottom: 1px solid #e5e7eb; /* Soft separator between ride entries */
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }
        .ride-entry-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        .ride-entry-card:last-child {
            border-bottom: none; /* No border for the last item */
        }
        /* Styles for the chat bubble - Enhanced */
        .chat-message-container {
            display: flex;
            margin-bottom: 10px;
            /* No align-items: flex-end needed as no avatars to align with */
        }
        .chat-message-container.sent {
            justify-content: flex-end; /* Push driver messages to the right */
        }
        .chat-message-container.received {
            justify-content: flex-start; /* Push customer messages to the left */
        }
        /* Removed .chat-avatar styles */
        .chat-bubble {
            max-width: 75%; /* Slightly more width for messages */
            padding: 10px 14px;
            border-radius: 18px; /* More rounded corners */
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            /* Adjust margins since avatars are removed */
            margin: 0; /* Reset margins */
        }
        .chat-bubble.sent {
            background-color: #dcf8c6; /* Light green */
            color: #333;
            border-bottom-right-radius: 4px; /* Pointed corner */
            margin-left: auto; /* Push to right */
        }
        .chat-bubble.received {
            background-color: #e5e7eb; /* Light gray */
            color: #333;
            border-bottom-left-radius: 4px; /* Pointed corner */
            margin-right: auto; /* Push to left */
        }
        .chat-timestamp {
            font-size: 0.7rem;
            color: #718096;
            margin-top: 4px;
            text-align: right;
        }
        .chat-message-container.received .chat-timestamp {
            text-align: left;
        }
        /* Custom styles for progress bar */
        .progress-bar-container {
            background-color: #e2e8f0; /* bg-gray-200 */
            border-radius: 9999px; /* rounded-full */
            height: 8px; /* h-2 */
            overflow: hidden;
            margin-top: 8px; /* mt-2 */
        }
        .progress-bar-fill {
            background: linear-gradient(to right, #fb923c, #ea580c); /* from-orange-400 to-orange-700 */
            height: 100%;
            border-radius: 9999px; /* rounded-full */
            transition: width 0.5s ease-in-out;
        }
        /* Custom styles for trip cards */
        .trip-card {
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }
        .trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-green-50 min-h-screen p-4 flex items-center justify-center">
    <div class="max-w-md w-full bg-white p-6 rounded-2xl shadow-xl space-y-6">

        <!-- Header with profile -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">üöñ ChakraX Driver</h2>
                <p class="text-sm text-gray-500 mt-1">Welcome back, Captain!</p>
            </div>
            <img src="https://cdn-icons-png.flaticon.com/512/1995/1995574.png" alt="Driver" class="w-12 h-12 rounded-full border-2 border-emerald-500 p-0.5 shadow-sm">
        </div>

        <!-- Welcome & Status with Slider Toggle -->
        <div class="bg-green-100 p-4 rounded-xl text-center shadow-inner">
            <p class="text-lg text-gray-800 font-semibold">üôè Hello, <span id="dashboardDriverName" class="text-emerald-700">Driver</span></p>

            <div class="flex justify-center items-center gap-3 mt-4">
                <label class="text-sm text-gray-700 font-medium">Current Status:</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="statusSwitch" class="sr-only peer">
                    <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-emerald-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                </label>
            </div>

            <p id="statusText" class="mt-3 text-sm text-gray-700">You are currently: <strong class="text-red-600">Offline</strong></p>
        </div>

        <!-- New Ride Request Section (Dynamic) -->
        <div id="newRideSection" class="bg-blue-50 p-4 rounded-xl shadow-inner hidden border border-blue-200">
            <h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center justify-center gap-2">
                <span class="animate-pulse">üîî</span> New Ride Request!
            </h3>
            <div class="flex flex-col md:flex-row items-center justify-between gap-3 text-sm text-gray-700">
                <div class="text-center md:text-left space-y-1">
                    <p class="font-semibold">From: <span class="font-normal text-gray-800" id="requestFrom">Koramangala, Bengaluru</span></p>
                    <p class="font-semibold">To: <span class="font-normal text-gray-800" id="requestTo">Indiranagar, Bengaluru</span></p>
                    <p class="font-semibold">Fare: <span class="font-normal text-green-700 text-lg" id="requestFare">‚Çπ220</span></p>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="acceptRideAndShowCustomerDetails();" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        Accept Ride
                    </button>
                    <button onclick="showMessage('Ride declined.', 'info'); hideRideRequest();" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                        Cancel Ride
                    </button>
                </div>
            </div>

            <!-- Customer Details Section (Initially Hidden) -->
            <div id="customerDetailsSection" class="hidden mt-6 pt-4 border-t border-blue-300 text-gray-800">
                <h4 class="text-base font-bold text-blue-700 mb-2">Customer Details:</h4>
                <div class="flex items-center space-x-3 mb-2">
                    <img id="customerPhoto" src="https://placehold.co/40x40/cccccc/ffffff?text=C" alt="Customer" class="w-10 h-10 rounded-full border-2 border-blue-400">
                    <div>
                        <p class="font-semibold" id="customerName">Priya Sharma</p>
                        <p class="text-sm text-gray-600" id="customerRating">Rating: ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (4.9)</p>
                    </div>
                </div>
                <p class="text-sm">Pickup Instructions: <span class="font-normal" id="customerInstructions">Near main gate, next to the cafe.</span></p>
                <p class="text-sm mt-1">Booking Time: <span class="font-normal" id="bookingTime">10:30 AM (2 min ago)</span></p>
                <p class="text-sm mt-1">Payment Method: <span class="font-normal" id="paymentMethod">Online Wallet</span></p>

                <!-- New: Customer Interaction Buttons -->
                <div class="flex gap-2 mt-4">
                    <button onclick="initiateCall();" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                        üìû Call Customer
                    </button>
                    <button onclick="openChatModal();" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-3 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                        üí¨ Chat
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Buttons -->
        <div class="grid grid-cols-1 gap-4 text-center">
            <button onclick="showEarnings()" class="bg-emerald-600 hover:bg-emerald-700 text-white py-3 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-75">
                üí∞ View Earnings
            </button>

            <button onclick="showPromotions()" class="bg-orange-500 hover:bg-orange-600 text-white py-3 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75">
                üéÅ Promotions & Incentives
            </button>

            <button onclick="showTripHistory()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                üõ£Ô∏è Trip History
            </button>

            <button onclick="showMessage('Profile view coming soon!', 'info')" class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                üë§ My Profile
            </button>
            <button onclick="showMessage('Logged out successfully!', 'info');" class="bg-gray-800 hover:bg-black text-white py-3 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-700 focus:ring-opacity-75">
                üö™ Logout
            </button>
        </div>
    </div>

    <!-- Earnings Modal -->
    <div id="earningsModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white w-11/12 max-w-lg p-6 rounded-xl shadow-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeEarnings()" class="absolute top-3 right-3 text-gray-600 hover:text-black text-xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-emerald-700 mb-6 text-center">üìä Your Earnings Dashboard</h2>

            <div class="space-y-6 text-gray-700">
                <!-- Current Earnings Summary (Weekly) -->
                <div class="bg-emerald-500 text-white p-5 rounded-xl shadow-md text-center">
                    <p class="text-sm font-semibold">Total Earnings</p>
                    <p id="totalEarningsDisplay" class="text-4xl font-bold mt-1">‚Çπ0</p>
                    <p id="weeklyPeriodDisplay" class="text-xs mt-2">Week of --</p>
                </div>

                <!-- Key Weekly Metrics -->
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Key Weekly Metrics</h3>
                <div class="grid grid-cols-3 gap-4 text-center text-sm font-semibold">
                    <div class="bg-green-100 p-3 rounded-lg shadow-sm">
                        <p id="ridesThisWeek" class="text-emerald-700 text-xl font-bold">0</p>
                        <p class="text-gray-600">Rides</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg shadow-sm">
                        <p id="avgRatingDisplay" class="text-emerald-700 text-xl font-bold">0.0</p>
                        <p class="text-gray-600">Avg. Rating</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg shadow-sm">
                        <p id="onlineHoursDisplay" class="text-emerald-700 text-xl font-bold">0<span class="text-lg">h</span></p>
                        <p class="text-gray-600">Online Hours</p>
                    </div>
                </div>

                <!-- Performance Metrics (KPI) -->
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Your Performance At A Glance</h3>
                <div class="grid grid-cols-2 gap-4 text-center text-sm font-semibold">
                    <div class="bg-purple-100 p-3 rounded-lg shadow-sm">
                        <p id="acceptanceRateDisplay" class="text-purple-700 text-xl font-bold">0<span class="text-lg">%</span></p>
                        <p class="text-gray-600">Acceptance Rate</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg shadow-sm">
                        <p id="completionRateDisplay" class="text-purple-700 text-xl font-bold">0<span class="text-lg">%</span></p>
                        <p class="text-gray-600">Completion Rate</p>
                    </div>
                </div>

                <!-- Detailed Ride History / Earnings Breakdown with Filter -->
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Detailed Ride History</h3>

                <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center gap-2">
                    <label for="weekFilter" class="text-sm font-medium text-gray-700">Select Week:</label>
                    <select id="weekFilter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm w-full sm:w-auto">
                        <!-- Options will be dynamically populated by JavaScript -->
                    </select>
                </div>

                <div id="rideHistoryContainer" class="space-y-4">
                    <!-- Ride entries will be dynamically populated here -->
                </div>

                <!-- Weekly & Monthly Overview Call to Action -->
                <div class="mt-6 pt-4 border-t-2 border-dashed border-gray-300 text-center">
                    <p class="text-lg font-semibold text-gray-800">Looking for more? </p>
                    <p class="text-sm text-gray-600 mt-1">Access your detailed weekly and monthly earnings reports, along with in-depth performance analytics, in your Trip History section!</p>
                </div>

            </div>
        </div>
    </div>

    <!-- Promotions Modal -->
    <div id="promotionsModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white w-11/12 max-w-lg p-6 rounded-xl shadow-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closePromotions()" class="absolute top-3 right-3 text-gray-600 hover:text-black text-xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-orange-700 mb-6 text-center">üéÅ Your Promotions & Incentives</h2>

            <div class="space-y-6 text-gray-700">
                <!-- Active Promotions -->
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Active Promotions</h3>
                <div id="activePromotionsContainer" class="space-y-4">
                    <!-- Promotions will be dynamically populated here -->
                </div>

                <!-- Completed Incentives -->
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4 mt-8">Completed Incentives</h3>
                <div id="completedIncentivesContainer" class="space-y-4">
                    <!-- Completed incentives will be dynamically populated here -->
                </div>

                <!-- Future Incentives / Info -->
                <div class="mt-6 pt-4 border-t-2 border-dashed border-gray-300 text-center">
                    <p class="text-lg font-semibold text-gray-800">Stay Tuned!</p>
                    <p class="text-sm text-gray-600 mt-1">New promotions and exciting incentives are added regularly. Keep driving to unlock more rewards!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box Modal (for alerts) -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[100] p-4">
        <div class="bg-white p-6 rounded-xl shadow-lg relative max-w-sm w-11/12 text-center transform scale-100 transition-transform duration-300 ease-out">
            <button onclick="closeMessage()" class="absolute top-3 right-3 text-gray-600 hover:text-black text-xl font-bold">&times;</button>
            <p id="messageContent" class="text-lg text-gray-800 mb-4"></p>
            <button onclick="closeMessage()" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-5 rounded-lg shadow-md transition-all duration-200 ease-in-out">OK</button>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white w-11/12 max-w-md p-6 rounded-xl shadow-lg relative flex flex-col h-[80vh] sm:h-[600px]">
            <button onclick="closeChatModal()" class="absolute top-3 right-3 text-gray-600 hover:text-black text-xl font-bold">&times;</button>
            <h2 class="text-xl font-bold text-indigo-700 mb-4 text-center">üí¨ Chat with <span id="chatCustomerName">Customer</span></h2>

            <!-- Chat messages display area -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 border border-gray-200 rounded-lg mb-4 bg-gray-50 flex flex-col">
                <!-- Chat messages will be appended here -->
            </div>

            <!-- Quick Reply Buttons -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="sendQuickReply('On my way!')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-2 px-3 rounded-lg transition-all duration-150">On my way!</button>
                <button onclick="sendQuickReply('Arriving in 2 mins.')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-2 px-3 rounded-lg transition-all duration-150">Arriving in 2 mins.</button>
                <button onclick="sendQuickReply('Facing slight traffic.')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-2 px-3 rounded-lg transition-all duration-150">Facing slight traffic.</button>
                <button onclick="sendQuickReply('Please confirm pickup location.')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-2 px-3 rounded-lg transition-all duration-150">Confirm pickup?</button>
            </div>

            <!-- Chat input area -->
            <div class="flex">
                <input type="text" id="chatInput" class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Type your message...">
                <button onclick="sendMessage()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-5 rounded-r-lg shadow-md transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Trip History Modal (New, integrated from trip-history-page) -->
    <div id="tripHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white w-11/12 max-w-4xl p-6 rounded-xl shadow-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeTripHistory()" class="absolute top-3 right-3 text-gray-600 hover:text-black text-xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">üõ£Ô∏è Your Trip History</h2>

            <div class="space-y-6 text-gray-700">
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Past Rides</h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="dateRangeTripHistory" class="block text-sm font-medium text-gray-700 mb-1">Date Range:</label>
                        <select id="dateRangeTripHistory" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="filterTrips()">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="this_week">This Week</option>
                            <option value="last_30_days">Last 30 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <input type="text" id="customDatePickerTripHistory" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mt-2 hidden" placeholder="Select custom date range">
                    </div>

                    <div>
                        <label for="vehicleTypeTripHistory" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Type:</label>
                        <select id="vehicleTypeTripHistory" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="filterTrips()">
                            <option value="all">All</option>
                            <option value="Prime Sedan">Prime Sedan</option>
                            <option value="Bike">Bike</option>
                            <option value="Auto">Auto</option>
                        </select>
                    </div>

                    <div>
                        <label for="paymentMethodTripHistory" class="block text-sm font-medium text-gray-700 mb-1">Payment Method:</label>
                        <select id="paymentMethodTripHistory" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="filterTrips()">
                            <option value="all">All</option>
                            <option value="UPI">UPI</option>
                            <option value="Cash">Cash</option>
                            <option value="Wallet">Wallet</option>
                        </select>
                    </div>

                    <div class="col-span-full md:col-span-1">
                        <label for="sortByTripHistory" class="block text-sm font-medium text-gray-700 mb-1">Sort By:</label>
                        <select id="sortByTripHistory" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="sortTrips()">
                            <option value="date_desc">Date (Newest First)</option>
                            <option value="date_asc">Date (Oldest First)</option>
                            <option value="fare_desc">Fare (High to Low)</option>
                            <option value="fare_asc">Fare (Low to High)</option>
                            <option value="duration_desc">Duration (Long to Short)</option>
                            <option value="duration_asc">Duration (Short to Long)</option>
                        </select>
                    </div>

                    <div class="col-span-full md:col-span-2">
                        <label for="searchTripTripHistory" class="block text-sm font-medium text-gray-700 mb-1">Search Trip:</label>
                        <input type="text" id="searchTripTripHistory" placeholder="Search by location or details..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onkeyup="filterTrips()">
                    </div>
                </div>

                <div class="flex justify-end gap-2 mb-6">
                    <button onclick="exportTrips('csv')" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg shadow text-sm">Export CSV</button>
                    <button onclick="exportTrips('pdf')" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg shadow text-sm">Export PDF</button>
                </div>

                <div id="tripList" class="space-y-4">
                </div>

                <div id="noTripsMessage" class="hidden text-center text-gray-600 py-10">
                    <p class="text-lg font-semibold">üòî No trips found for the selected criteria.</p>
                    <p class="text-sm mt-2">Try adjusting your filters or check back later!</p>
                </div>

                <div class="mt-6 pt-4 border-t-2 border-dashed border-gray-300 text-center">
                    <p class="text-lg font-semibold text-gray-800">Need more detailed reports?</p>
                    <p class="text-sm text-gray-600 mt-1">Visit the 'My Profile' section for comprehensive analytics and downloadable trip logs.</p>
                </div>
            </div>
        </div>
    </div>


    <!-- JavaScript -->
    <script>
        // Helper to get a date string for a specific day relative to today
        function getDateString(offsetDays) {
            const d = new Date();
            d.setDate(d.getDate() + offsetDays);
            return d.toISOString().split('T')[0]; // Format YYYY-MM-DD
        }

        // Dummy data for different weeks (existing data for Earnings modal)
        const allRidesData = {
            "week_current": { // Week of Jun 17 - Jun 23
                period: 'Jun 17 - Jun 23',
                totalEarnings: '‚Çπ8,750',
                rides: 45,
                avgRating: 4.7,
                onlineHours: 50,
                acceptanceRate: 95,
                completionRate: 98,
                trips: [
                    { rideId: 'TRP001', customerName: 'Ravi K.', date: '19 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', cost: '‚Çπ180', pickup: 'Indiranagar', drop: 'Koramangala', feedback: '"Friendly!"' },
                    { rideId: 'TRP002', customerName: 'Priya S.', date: '19 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', cost: '‚Çπ250', pickup: 'Jayanagar', drop: 'Electronic City', feedback: '"Good driver"' },
                    { rideId: 'TRP003', customerName: 'Amit V.', date: '18 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', cost: '‚Çπ120', pickup: 'Whitefield', drop: 'Marathahalli', feedback: '"Smooth ride"' },
                    { rideId: 'TRP004', customerName: 'Deepa M.', date: '18 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', cost: '‚Çπ90', pickup: 'Domlur', drop: 'Shivajinagar', feedback: '"A bit slow"' },
                    { rideId: 'TRP005', customerName: 'Rahul G.', date: '17 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', cost: '‚Çπ300', pickup: 'HSR Layout', drop: 'MG Road', feedback: '"Pleasant"' },
                    { rideId: 'TRP006', customerName: 'Sonia P.', date: '17 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', cost: '‚Çπ150', pickup: 'BTM Layout', drop: 'Bannerghatta Road', feedback: '"Excellent!"' },
                    { rideId: 'TRP007', customerName: 'Vikram C.', date: '17 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', cost: '‚Çπ100', pickup: 'JP Nagar', drop: 'Kanakapura Road', feedback: '"Quick ride"' }
                ]
            },
            "week_last": { // Week of Jun 10 - Jun 16
                period: 'Jun 10 - Jun 16',
                totalEarnings: '‚Çπ7,200',
                rides: 40,
                avgRating: 4.5,
                onlineHours: 48,
                acceptanceRate: 92,
                completionRate: 96,
                trips: [
                    { rideId: 'TRP008', customerName: 'Neha K.', date: '16 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', cost: '‚Çπ200', pickup: 'MG Road', drop: 'Whitefield', feedback: '"Fantastic service!"' },
                    { rideId: 'TRP009', customerName: 'Arjun S.', date: '15 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', cost: '‚Çπ170', pickup: 'Koramangala', drop: 'Kalyan Nagar', feedback: '"Comfortable"' },
                    { rideId: 'TRP010', customerName: 'Pooja R.', date: '14 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', cost: '‚Çπ110', pickup: 'Electronic City', drop: 'Domlur', feedback: '"Smooth pickup"' },
                    { rideId: 'TRP011', customerName: 'Ganesh L.', date: '13 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', cost: '‚Çπ280', pickup: 'Marathahalli', drop: 'Airport', feedback: '"Very efficient"' },
                    { rideId: 'TRP012', customerName: 'Kavita B.', date: '12 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', cost: '‚Çπ95', pickup: 'Shivajinagar', drop: 'Richmond Road', feedback: '"Average"' }
                ]
            },
            "week_two_weeks_ago": { // Week of Jun 03 - Jun 09
                period: 'Jun 03 - Jun 09',
                totalEarnings: '‚Çπ6,500',
                rides: 38,
                avgRating: 4.4,
                onlineHours: 45,
                acceptanceRate: 90,
                completionRate: 95,
                trips: [
                    { rideId: 'TRP013', customerName: 'Rajesh N.', date: '09 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', cost: '‚Çπ160', pickup: 'Jayanagar', drop: 'Bannerghatta Road', feedback: '"Polite driver"' },
                    { rideId: 'TRP014', customerName: 'Anjali D.', date: '08 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', cost: '‚Çπ220', pickup: 'Indiranagar', drop: 'HSR Layout', feedback: '"Good route knowledge"' },
                    { rideId: 'TRP015', customerName: 'Suresh R.', date: '07 Jun 2025', rating: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', cost: '‚Çπ100', pickup: 'Koramangala', drop: 'BTM Layout', feedback: '"Fast ride"' }
                ]
            }
        };

        // Dummy Customer Data for a new ride request
        const dummyCustomer = {
            name: "Aisha M.",
            rating: "4.7",
            photo: "https://placehold.co/40x40/007bff/ffffff?text=AM", // Placeholder for customer photo
            instructions: "Waiting near the big banyan tree. Please call if you can't find me.",
            bookingTime: "11:15 AM (1 min ago)",
            paymentMethod: "Cash",
            phoneNumber: "+91 98765 43210" // Dummy phone number
        };

        // Dummy data for Promotions and Incentives
        const promotionsData = {
            active: [
                {
                    icon: 'üåü',
                    title: "Weekend Ride Bonus",
                    description: "Complete 10 rides this weekend (Sat-Sun) and get a ‚Çπ500 bonus!",
                    status: "Active",
                    progress: "5/10", // Format: "current/total"
                    validity: "Ends: Jun 29, 2025"
                },
                {
                    icon: '‚ö°',
                    title: "Peak Hour Incentive",
                    description: "Earn 1.5x on fares during 8 AM - 10 AM and 5 PM - 7 PM on weekdays.",
                    status: "Active",
                    validity: "Ongoing"
                },
                {
                    icon: 'ü§ù',
                    title: "Refer a Friend",
                    description: "Refer a new driver and earn ‚Çπ1,000 once they complete their first 5 rides.",
                    status: "Active",
                    validity: "No expiry"
                }
            ],
            completed: [
                {
                    icon: '‚úÖ',
                    title: "Monday Mania Bonus",
                    description: "Completed 7 rides on Monday, earned ‚Çπ200 bonus!",
                    date: "Jun 23, 2025",
                    earnings: "‚Çπ200"
                },
                {
                    icon: 'üéâ',
                    title: "New Driver Welcome Bonus",
                    description: "Successfully completed your first 20 rides within the first week. Earned ‚Çπ1,500!",
                    date: "Jun 10, 2025",
                    earnings: "‚Çπ1,500"
                }
            ]
        };


        // Online/Offline Status Toggle
        const statusText = document.getElementById("statusText");
        const toggleSwitch = document.getElementById("statusSwitch");
        const newRideSection = document.getElementById("newRideSection");
        const customerDetailsSection = document.getElementById("customerDetailsSection");

        toggleSwitch.addEventListener("change", () => {
            if (toggleSwitch.checked) {
                statusText.innerHTML = `You are currently: <strong class="text-green-600">Online</strong>`;
                // Simulate showing a ride request after a delay when going online
                setTimeout(() => {
                    newRideSection.classList.remove("hidden");
                    customerDetailsSection.classList.add("hidden"); // Ensure customer details are hidden initially
                }, 1000);
            } else {
                statusText.innerHTML = `You are currently: <strong class="text-red-600">Offline</strong>`;
                newRideSection.classList.add("hidden"); // Hide new ride section when offline
                customerDetailsSection.classList.add("hidden"); // Hide customer details if offline
            }
        });

        // Function to hide the ride request section (and customer details)
        function hideRideRequest() {
            newRideSection.classList.add("hidden");
            customerDetailsSection.classList.add("hidden");
        }

        // Message Box Functions (Common for all modals/pages)
        const messageModal = document.getElementById("messageModal");
        const messageContent = document.getElementById("messageContent");

        function showMessage(message, type = 'info') {
            messageContent.textContent = message;
            messageModal.classList.remove("hidden");
            // Add a slight transform for a pop-in effect
            messageModal.querySelector('.bg-white').classList.add('scale-100');
        }

        function closeMessage() {
            messageModal.querySelector('.bg-white').classList.remove('scale-100');
            messageModal.classList.add("hidden");
            // Special handling for logout: redirect after closing message
            if (messageContent.textContent === 'Logged out successfully!') {
                // In a real app, this would redirect to a login page, e.g., window.location.href = "login.html";
                console.log("Logged out. (Simulated redirect)");
            }
        }

        // Function: Accept Ride and Show Customer Details
        function acceptRideAndShowCustomerDetails() {
            showMessage('Ride accepted! Customer details displayed below. Navigating now...', 'success');

            // Populate customer details
            document.getElementById('customerName').textContent = dummyCustomer.name;
            document.getElementById('customerRating').textContent = `Rating: ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (${dummyCustomer.rating})`;
            document.getElementById('customerPhoto').src = dummyCustomer.photo;
            document.getElementById('customerInstructions').textContent = dummyCustomer.instructions;
            document.getElementById('bookingTime').textContent = dummyCustomer.bookingTime;
            document.getElementById('paymentMethod').textContent = dummyCustomer.paymentMethod;

            // Show the customer details section
            customerDetailsSection.classList.remove("hidden");
        }

        // --- Customer Interaction Functions ---

        // Phone Call Function
        function initiateCall() {
            showMessage(`Calling ${dummyCustomer.name} at ${dummyCustomer.phoneNumber}...`, 'info');
        }

        // Chat Modal Elements
        const chatModal = document.getElementById('chatModal');
        const chatCustomerName = document.getElementById('chatCustomerName');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');

        // Dummy chat history
        const chatHistory = [
            { sender: 'customer', message: 'Hi, are you on the way?', timestamp: '11:16 AM' },
            { sender: 'driver', message: 'Yes, almost there! Traffic is a bit heavy.', timestamp: '11:17 AM' },
            { sender: 'customer', message: 'Okay, no problem. Just wanted to check. Thanks!', timestamp: '11:18 AM' }
        ];

        // Possible customer responses for simulation
        const customerResponses = [
            "Got it! Looking forward to the ride.",
            "Okay, thanks for the update!",
            "No problem, see you soon.",
            "Appreciate the heads-up!",
            "Thanks for letting me know."
        ];

        // Function to open chat modal
        function openChatModal() {
            chatCustomerName.textContent = dummyCustomer.name;
            chatModal.classList.remove("hidden");
            populateChatMessages();
            // Scroll to the bottom of the chat
            chatMessages.scrollTop = chatMessages.scrollHeight;
            chatInput.focus(); // Focus on the input field
        }

        // Function to close chat modal
        function closeChatModal() {
            chatModal.classList.add("hidden");
            chatMessages.innerHTML = ''; // Clear messages when closing
            chatInput.value = ''; // Clear input field
        }

        // Function to display messages in the chat modal
        function populateChatMessages() {
            chatMessages.innerHTML = ''; // Clear existing messages
            chatHistory.forEach(msg => {
                appendChatMessage(msg.message, msg.sender, msg.timestamp);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }

        // Helper function to append a single message to the chat
        function appendChatMessage(message, sender, timestamp) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('chat-message-container', sender === 'driver' ? 'sent' : 'received');

            const bubbleElement = document.createElement('div');
            bubbleElement.classList.add('chat-bubble', sender === 'driver' ? 'sent' : 'received');
            bubbleElement.textContent = message;

            const timestampElement = document.createElement('div');
            timestampElement.classList.add('chat-timestamp');
            timestampElement.textContent = timestamp;

            if (sender === 'driver') {
                messageContainer.appendChild(bubbleElement);
                messageContainer.appendChild(timestampElement);
            } else {
                messageContainer.appendChild(bubbleElement);
                messageContainer.appendChild(timestampElement);
            }

            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to latest message
        }

        // Function to send a message
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                const now = new Date();
                const time = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                chatHistory.push({ sender: 'driver', message: message, timestamp: time });
                appendChatMessage(message, 'driver', time);
                chatInput.value = '';

                // Simulate a customer response after a short delay
                setTimeout(() => {
                    const randomResponse = customerResponses[Math.floor(Math.random() * customerResponses.length)];
                    const customerTime = new Date();
                    const customerTimeFormatted = customerTime.getHours().toString().padStart(2, '0') + ':' + customerTime.getMinutes().toString().padStart(2, '0');
                    chatHistory.push({ sender: 'customer', message: randomResponse, timestamp: customerTimeFormatted });
                    appendChatMessage(randomResponse, 'customer', customerTimeFormatted);
                }, 1500); // Customer replies after 1.5 seconds
            } else {
                showMessage("Please type a message to send.", "warning");
            }
        }

        // Function for quick replies
        function sendQuickReply(reply) {
            chatInput.value = reply;
            sendMessage(); // Send the quick reply as a regular message
        }

        // Ensure the chat input sends message on Enter key press
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });


        // Earnings Modal Functions
        const earningsModal = document.getElementById("earningsModal");
        const weekFilter = document.getElementById("weekFilter");

        function showEarnings() {
            earningsModal.classList.remove("hidden");
            // Populate week filter options
            populateWeekFilterOptions(weekFilter, allRidesData, 'week_current');
            // Display initial earnings for the current week
            updateEarningsDisplay('week_current');
        }

        function closeEarnings() {
            earningsModal.classList.add("hidden");
        }

        weekFilter.addEventListener('change', (event) => {
            const selectedWeek = event.target.value;
            updateEarningsDisplay(selectedWeek);
        });

        function updateEarningsDisplay(weekKey) {
            const data = allRidesData[weekKey];
            if (!data) return;

            document.getElementById('totalEarningsDisplay').textContent = data.totalEarnings;
            document.getElementById('weeklyPeriodDisplay').textContent = `Week of ${data.period}`;
            document.getElementById('ridesThisWeek').textContent = data.rides;
            document.getElementById('avgRatingDisplay').textContent = data.avgRating.toFixed(1);
            document.getElementById('onlineHoursDisplay').textContent = `${data.onlineHours}h`;
            document.getElementById('acceptanceRateDisplay').textContent = `${data.acceptanceRate}%`;
            document.getElementById('completionRateDisplay').textContent = `${data.completionRate}%`;

            populateRideHistory(data.trips);
        }

        function populateRideHistory(trips) {
            const rideHistoryContainer = document.getElementById('rideHistoryContainer');
            rideHistoryContainer.innerHTML = ''; // Clear previous entries

            if (trips.length === 0) {
                rideHistoryContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No rides recorded for this period.</p>';
                return;
            }

            trips.forEach(trip => {
                const card = document.createElement('div');
                card.classList.add('ride-entry-card', 'bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                card.innerHTML = `
                    <div class="flex items-center justify-between text-sm mb-2">
                        <span class="font-semibold text-gray-800">${trip.date}</span>
                        <span class="text-green-600 font-bold text-lg">${trip.cost}</span>
                    </div>
                    <p class="text-gray-700 text-sm mb-1">
                        <span class="font-medium">From:</span> ${trip.pickup}
                    </p>
                    <p class="text-gray-700 text-sm mb-1">
                        <span class="font-medium">To:</span> ${trip.drop}
                    </p>
                    <div class="flex items-center text-xs text-gray-500 mt-2">
                        <span class="mr-2">${trip.rating}</span>
                        <span class="italic">${trip.feedback}</span>
                    </div>
                `;
                rideHistoryContainer.appendChild(card);
            });
        }

        // Promotions Modal Functions
        const promotionsModal = document.getElementById("promotionsModal");

        function showPromotions() {
            promotionsModal.classList.remove("hidden");
            populatePromotions();
        }

        function closePromotions() {
            promotionsModal.classList.add("hidden");
        }

        function populatePromotions() {
            const activeContainer = document.getElementById('activePromotionsContainer');
            const completedContainer = document.getElementById('completedIncentivesContainer');
            activeContainer.innerHTML = '';
            completedContainer.innerHTML = '';

            if (promotionsData.active.length === 0) {
                activeContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No active promotions currently. Check back soon!</p>';
            } else {
                promotionsData.active.forEach(promo => {
                    const progressHtml = promo.progress ?
                        `<div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${(parseInt(promo.progress.split('/')[0]) / parseInt(promo.progress.split('/')[1])) * 100}%;"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${promo.progress} completed</p>` : '';

                    const promoCard = document.createElement('div');
                    promoCard.classList.add('bg-orange-50', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-orange-200');
                    promoCard.innerHTML = `
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">${promo.icon}</span>
                            <div>
                                <h4 class="font-bold text-orange-800">${promo.title}</h4>
                                <p class="text-sm text-gray-700">${promo.description}</p>
                            </div>
                        </div>
                        ${progressHtml}
                        <p class="text-xs text-gray-500 mt-2"><span class="font-semibold">Status:</span> ${promo.status}</p>
                        <p class="text-xs text-gray-500"><span class="font-semibold">Validity:</span> ${promo.validity}</p>
                    `;
                    activeContainer.appendChild(promoCard);
                });
            }

            if (promotionsData.completed.length === 0) {
                completedContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No completed incentives yet.</p>';
            } else {
                promotionsData.completed.forEach(incentive => {
                    const incentiveCard = document.createElement('div');
                    incentiveCard.classList.add('bg-green-50', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-green-200');
                    incentiveCard.innerHTML = `
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">${incentive.icon}</span>
                            <div>
                                <h4 class="font-bold text-green-800">${incentive.title}</h4>
                                <p class="text-sm text-gray-700">${incentive.description}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500 mt-2">
                            <span>Date: ${incentive.date}</span>
                            <span class="font-bold text-green-700">Earned: ${incentive.earnings}</span>
                        </div>
                    `;
                    completedContainer.appendChild(incentiveCard);
                });
            }
        }


        // Generic function to populate week filter options
        function populateWeekFilterOptions(selectElement, data, defaultKey) {
            selectElement.innerHTML = ''; // Clear existing options
            Object.keys(data).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `Week of ${data[key].period}`;
                if (key === defaultKey) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // *******************************************************************
        // NEW: Trip History Modal Integration (from trip-history-page)
        // *******************************************************************

        const tripHistoryModal = document.getElementById("tripHistoryModal");
        // Renamed IDs to avoid conflict with earnings modal if both used the same filter/sort IDs
        const dateRangeTripHistorySelect = document.getElementById('dateRangeTripHistory');
        const customDatePickerTripHistory = document.getElementById('customDatePickerTripHistory');
        const vehicleTypeTripHistorySelect = document.getElementById('vehicleTypeTripHistory');
        const paymentMethodTripHistorySelect = document.getElementById('paymentMethodTripHistory');
        const sortByTripHistorySelect = document.getElementById('sortByTripHistory');
        const searchTripTripHistoryInput = document.getElementById('searchTripTripHistory');

        const tripList = document.getElementById('tripList');
        const noTripsMessage = document.getElementById('noTripsMessage');

        // Dummy trip data for the Trip History Modal (simplified, as "driver" for self-trips is redundant)
        const tripData = [
            {
                id: 1, pickup: 'MG Road', drop: 'Indiranagar', date: getDateString(0), time: '10:30 AM',
                fare: 250, duration: 24, vehicle: 'Prime Sedan', payment: 'UPI'
            },
            {
                id: 2, pickup: 'Koramangala', drop: 'Electronic City', date: getDateString(-1), time: '05:00 PM',
                fare: 420, duration: 45, vehicle: 'Bike', payment: 'Cash'
            },
            {
                id: 3, pickup: 'Jayanagar', drop: 'Shivajinagar', date: getDateString(-2), time: '09:15 AM',
                fare: 180, duration: 18, vehicle: 'Auto', payment: 'Wallet'
            },
            {
                id: 4, pickup: 'Marathahalli', drop: 'Whitefield', date: getDateString(-3), time: '02:00 PM',
                fare: 300, duration: 30, vehicle: 'Prime Sedan', payment: 'UPI'
            },
            {
                id: 5, pickup: 'Hebbal', drop: 'Airport', date: getDateString(-8), time: '06:00 AM',
                fare: 800, duration: 60, vehicle: 'Prime Sedan', payment: 'Wallet'
            },
            {
                id: 6, pickup: 'Banashankari', drop: 'Basavanagudi', date: getDateString(-20), time: '11:00 AM',
                fare: 120, duration: 15, vehicle: 'Auto', payment: 'Cash'
            }
        ];

        let flatpickrInstanceTripHistory; // Separate instance for trip history modal

        function showTripHistory() {
            tripHistoryModal.classList.remove("hidden");
            // Initialize Flatpickr only when custom is selected
            if (dateRangeTripHistorySelect.value === 'custom') {
                initFlatpickrTripHistory();
            } else {
                if (flatpickrInstanceTripHistory) {
                    flatpickrInstanceTripHistory.destroy();
                    customDatePickerTripHistory.value = '';
                }
            }
            filterTrips(); // Render trips based on initial filters
        }

        function closeTripHistory() {
            tripHistoryModal.classList.add("hidden");
        }

        // Initialize Flatpickr for custom date range within the trip history modal
        function initFlatpickrTripHistory() {
            if (flatpickrInstanceTripHistory) {
                flatpickrInstanceTripHistory.destroy();
            }
            flatpickrInstanceTripHistory = flatpickr(customDatePickerTripHistory, {
                mode: "range",
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        filterTrips();
                    }
                }
            });
        }

        dateRangeTripHistorySelect.addEventListener('change', () => {
            if (dateRangeTripHistorySelect.value === 'custom') {
                customDatePickerTripHistory.classList.remove('hidden');
                initFlatpickrTripHistory();
            } else {
                customDatePickerTripHistory.classList.add('hidden');
                if (flatpickrInstanceTripHistory) {
                    flatpickrInstanceTripHistory.destroy();
                    customDatePickerTripHistory.value = '';
                }
            }
            filterTrips();
        });

        vehicleTypeTripHistorySelect.addEventListener('change', filterTrips);
        paymentMethodTripHistorySelect.addEventListener('change', filterTrips);
        sortByTripHistorySelect.addEventListener('change', sortTrips);
        searchTripTripHistoryInput.addEventListener('keyup', filterTrips);


        function renderTrips(tripsToDisplay) {
            tripList.innerHTML = '';
            if (tripsToDisplay.length === 0) {
                noTripsMessage.classList.remove('hidden');
            } else {
                noTripsMessage.classList.add('hidden');
                tripsToDisplay.forEach(trip => {
                    const tripCard = `
                        <div class="trip-card bg-white p-4 rounded-xl shadow-md border border-gray-200 cursor-pointer hover:shadow-lg transition-shadow duration-200" onclick="showMessage('Viewing details for Trip ID: ${trip.id}')">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2">
                                <p class="font-semibold text-gray-800">üìç Pickup: ${trip.pickup} <br> üèÅ Drop: ${trip.drop}</p>
                                <p class="text-sm text-gray-600 mt-1 sm:mt-0">üóì ${new Date(trip.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} | üïí ${trip.time}</p>
                            </div>
                            <div class="flex items-center justify-between text-sm text-gray-700 mb-2">
                                <p>üí∏ Fare: <span class="font-bold text-emerald-700">‚Çπ${trip.fare}</span></p>
                                <p>‚è± Duration: ${trip.duration} mins</p>
                            </div>
                            <div class="flex items-center justify-between text-sm text-gray-700">
                                <p>${getVehicleIcon(trip.vehicle)} Mode: ${trip.vehicle} <span class="ml-2">üí≥ ${trip.payment}</span></p>
                                <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs py-1 px-3 rounded-full">View Receipt</button>
                            </div>
                            <!-- Removed driver/rating as it's the current driver's own history -->
                        </div>
                    `;
                    tripList.insertAdjacentHTML('beforeend', tripCard);
                });
            }
        }

        function getVehicleIcon(vehicleType) {
            switch (vehicleType) {
                case 'Bike': return 'üèç';
                case 'Auto': return 'üõ∫';
                case 'Prime Sedan': return 'üöó';
                default: return '';
            }
        }

        function filterTrips() {
            let filtered = [...tripData];
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time for comparison
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(today.getDate() - 7);
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            // Date Range Filter
            const selectedDateRange = dateRangeTripHistorySelect.value;
            if (selectedDateRange !== 'all') {
                filtered = filtered.filter(trip => {
                    const tripDate = new Date(trip.date);
                    tripDate.setHours(0, 0, 0, 0);

                    if (selectedDateRange === 'today') {
                        return tripDate.getTime() === today.getTime();
                    } else if (selectedDateRange === 'this_week') {
                        return tripDate >= oneWeekAgo && tripDate <= today;
                    } else if (selectedDateRange === 'last_30_days') {
                        return tripDate >= thirtyDaysAgo && tripDate <= today;
                    } else if (selectedDateRange === 'custom') {
                        const dateRangeValue = customDatePickerTripHistory.value;
                        if (dateRangeValue) {
                            const [startDateStr, endDateStr] = dateRangeValue.split(' to ');
                            if (startDateStr && endDateStr) {
                                const startDate = new Date(startDateStr);
                                const endDate = new Date(endDateStr);
                                startDate.setHours(0,0,0,0);
                                endDate.setHours(23,59,59,999); // Include full end day
                                return tripDate >= startDate && tripDate <= endDate;
                            }
                        }
                        return true; // If custom range is selected but not set, show all
                    }
                    return true;
                });
            }

            // Vehicle Type Filter
            const selectedVehicleType = vehicleTypeTripHistorySelect.value;
            if (selectedVehicleType !== 'all') {
                filtered = filtered.filter(trip => trip.vehicle === selectedVehicleType);
            }

            // Payment Method Filter
            const selectedPaymentMethod = paymentMethodTripHistorySelect.value;
            if (selectedPaymentMethod !== 'all') {
                filtered = filtered.filter(trip => trip.payment === selectedPaymentMethod);
            }

            // Search Filter
            const searchTerm = searchTripTripHistoryInput.value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(trip =>
                    trip.pickup.toLowerCase().includes(searchTerm) ||
                    trip.drop.toLowerCase().includes(searchTerm) ||
                    trip.vehicle.toLowerCase().includes(searchTerm) ||
                    trip.payment.toLowerCase().includes(searchTerm)
                );
            }

            sortTrips(filtered); // Sort after filtering
        }

        function sortTrips(filteredTrips = null) {
            const tripsToSort = filteredTrips || [...tripData];
            const sortBy = sortByTripHistorySelect.value;

            tripsToSort.sort((a, b) => {
                if (sortBy === 'date_desc') {
                    return new Date(b.date) - new Date(a.date);
                } else if (sortBy === 'date_asc') {
                    return new Date(a.date) - new Date(b.date);
                } else if (sortBy === 'fare_desc') {
                    return b.fare - a.fare;
                } else if (sortBy === 'fare_asc') {
                    return a.fare - b.fare;
                } else if (sortBy === 'duration_desc') {
                    return b.duration - a.duration;
                } else if (sortBy === 'duration_asc') {
                    return a.duration - b.duration;
                }
                return 0;
            });
            renderTrips(tripsToSort);
        }

        function exportTrips(format) {
            const tripsToExport = Array.from(tripList.children).map(card => {
                const pickupDropElement = card.querySelector('.font-semibold');
                const pickup = pickupDropElement ? pickupDropElement.innerHTML.split('<br>')[0].replace('üìç Pickup: ', '').trim() : 'N/A';
                const drop = pickupDropElement ? pickupDropElement.innerHTML.split('<br>')[1].replace('üèÅ Drop: ', '').trim() : 'N/A';

                const dateTimeElement = card.querySelector('.text-sm.text-gray-600');
                const date = dateTimeElement ? dateTimeElement.innerText.split(' | ')[0].replace('üóì ', '').trim() : 'N/A';
                const time = dateTimeElement ? dateTimeElement.innerText.split(' | ')[1].replace('üïí ', '').trim() : 'N/A';

                const fareElement = card.querySelector('.font-bold.text-emerald-700');
                const fare = fareElement ? fareElement.innerText.replace('‚Çπ', '').trim() : 'N/A';

                const durationElement = card.querySelector('p:nth-child(2)'); // Assuming it's the second paragraph within the fare/duration div
                const duration = durationElement ? durationElement.innerText.replace('‚è± Duration: ', '').replace(' mins', '').trim() : 'N/A';

                const vehiclePaymentElement = card.querySelector('.flex.items-center.justify-between.text-sm.text-gray-700 p');
                const vehicleMatch = vehiclePaymentElement ? vehiclePaymentElement.innerText.match(/Mode: (.*?) üí≥/) : null;
                const vehicle = vehicleMatch && vehicleMatch[1] ? vehicleMatch[1].trim() : 'N/A';

                const paymentMatch = vehiclePaymentElement ? vehiclePaymentElement.innerText.match(/üí≥ (.*)/) : null;
                const payment = paymentMatch && paymentMatch[1] ? paymentMatch[1].trim() : 'N/A';

                const tripIdMatch = card.getAttribute('onclick').match(/Trip ID: (\d+)/);
                const tripId = tripIdMatch ? tripIdMatch[1] : 'N/A';

                return {
                    'Trip ID': tripId,
                    'Pickup Location': pickup,
                    'Drop Location': drop,
                    'Date': date,
                    'Time': time,
                    'Fare Earned (‚Çπ)': fare,
                    'Trip Duration (mins)': duration,
                    'Vehicle Type': vehicle,
                    'Payment Mode': payment,
                };
            });

            if (tripsToExport.length === 0) {
                showMessage('No trips to export!', 'info');
                return;
            }

            if (format === 'csv') {
                const header = Object.keys(tripsToExport[0]).join(',');
                const rows = tripsToExport.map(row => Object.values(row).map(value => `"${String(value).replace(/"/g, '""')}"`).join(',')).join('\n'); // Handle commas and quotes in data
                const csvContent = "data:text/csv;charset=utf-8," + header + "\n" + rows;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "trip_history.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('Trips exported to CSV!', 'success');
            } else if (format === 'pdf') {
                showMessage('PDF export functionality is not yet implemented. Please use CSV export for now.', 'info');
            }
        }

        // Initial calls when page loads
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dashboardDriverName').textContent = 'Prabhu'; // Set a default driver name
            // Make sure the ride request section is hidden on load unless specifically triggered
            newRideSection.classList.add("hidden");
            customerDetailsSection.classList.add("hidden");

            // Initial render for the main dashboard's earnings history
            updateEarningsDisplay('week_current');
        });
    </script>
</body>
</html>
