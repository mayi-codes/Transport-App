<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trip History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-green-50 min-h-screen p-4">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-xl">
    
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800">ğŸ›£ Trip History</h2>
      <button onclick="window.history.back()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg shadow">
        Back
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div>
        <label for="dateRange" class="block text-sm font-medium text-gray-700 mb-1">Date Range:</label>
        <select id="dateRange" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500" onchange="filterTrips()">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="this_week">This Week</option>
          <option value="last_30_days">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
        <input type="text" id="customDatePicker" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 mt-2 hidden" placeholder="Select custom date range">
      </div>

      <div>
        <label for="vehicleType" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Type:</label>
        <select id="vehicleType" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500" onchange="filterTrips()">
          <option value="all">All</option>
          <option value="Prime Sedan">Prime Sedan</option>
          <option value="Bike">Bike</option>
          <option value="Auto">Auto</option>
        </select>
      </div>

      <div>
        <label for="paymentMethod" class="block text-sm font-medium text-gray-700 mb-1">Payment Method:</label>
        <select id="paymentMethod" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500" onchange="filterTrips()">
          <option value="all">All</option>
          <option value="UPI">UPI</option>
          <option value="Cash">Cash</option>
          <option value="Wallet">Wallet</option>
        </select>
      </div>

      <div class="col-span-full md:col-span-1">
        <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">Sort By:</label>
        <select id="sortBy" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500" onchange="sortTrips()">
          <option value="date_desc">Date (Newest First)</option>
          <option value="date_asc">Date (Oldest First)</option>
          <option value="fare_desc">Fare (High to Low)</option>
          <option value="fare_asc">Fare (Low to High)</option>
          <option value="duration_desc">Duration (Long to Short)</option>
          <option value="duration_asc">Duration (Short to Long)</option>
        </select>
      </div>

      <div class="col-span-full md:col-span-2">
        <label for="searchTrip" class="block text-sm font-medium text-gray-700 mb-1">Search Trip:</label>
        <input type="text" id="searchTrip" placeholder="Search by location or details..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500" onkeyup="filterTrips()">
      </div>
    </div>

    <div class="flex justify-end gap-2 mb-6">
      <button onclick="exportTrips('csv')" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg shadow text-sm">Export CSV</button>
      <button onclick="exportTrips('pdf')" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg shadow text-sm">Export PDF</button>
    </div>

    <div id="tripList" class="space-y-4">
      </div>

    <div id="noTripsMessage" class="hidden text-center text-gray-600 py-10">
      <p class="text-lg font-semibold">ğŸ˜” No trips found for the selected criteria.</p>
      <p class="text-sm mt-2">Try adjusting your filters or check back later!</p>
    </div>

  </div>

  <script>
    // Helper to get a date string for a specific day relative to today
    function getDateString(offsetDays) {
      const d = new Date();
      d.setDate(d.getDate() + offsetDays);
      return d.toISOString().split('T')[0]; // Format YYYY-MM-DD
    }

    const tripData = [
      {
        id: 1,
        pickup: 'MG Road',
        drop: 'Indiranagar',
        date: getDateString(0), // Today
        time: '10:30 AM',
        fare: 250,
        duration: 24, // in minutes
        vehicle: 'Prime Sedan',
        payment: 'UPI',
        driver: 'Rajesh Kumar',
        rating: 4.8
      },
      {
        id: 2,
        pickup: 'Koramangala',
        drop: 'Electronic City',
        date: getDateString(-1), // Yesterday
        time: '05:00 PM',
        fare: 420,
        duration: 45,
        vehicle: 'Bike',
        payment: 'Cash',
        driver: 'Priya Sharma',
        rating: 4.5
      },
      {
        id: 3,
        pickup: 'Jayanagar',
        drop: 'Shivajinagar',
        date: getDateString(-2), // 2 days ago
        time: '09:15 AM',
        fare: 180,
        duration: 18,
        vehicle: 'Auto',
        payment: 'Wallet',
        driver: 'Amit Singh',
        rating: 4.9
      },
      {
        id: 4,
        pickup: 'Marathahalli',
        drop: 'Whitefield',
        date: getDateString(-3), // 3 days ago
        time: '02:00 PM',
        fare: 300,
        duration: 30,
        vehicle: 'Prime Sedan',
        payment: 'UPI',
        driver: 'Suresh Gowda',
        rating: 4.7
      },
      {
        id: 5,
        pickup: 'Hebbal',
        drop: 'Airport',
        date: getDateString(-8), // 8 days ago (outside this week but within last 30 days)
        time: '06:00 AM',
        fare: 800,
        duration: 60,
        vehicle: 'Prime Sedan',
        payment: 'Wallet',
        driver: 'Anjali Reddy',
        rating: 5.0
      },
      {
        id: 6,
        pickup: 'Banashankari',
        drop: 'Basavanagudi',
        date: getDateString(-20), // 20 days ago (within last 30 days)
        time: '11:00 AM',
        fare: 120,
        duration: 15,
        vehicle: 'Auto',
        payment: 'Cash',
        driver: 'Vijay Kumar',
        rating: 4.2
      }
    ];

    const tripList = document.getElementById('tripList');
    const noTripsMessage = document.getElementById('noTripsMessage');
    const dateRangeSelect = document.getElementById('dateRange');
    const customDatePicker = document.getElementById('customDatePicker');
    const vehicleTypeSelect = document.getElementById('vehicleType');
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const sortBySelect = document.getElementById('sortBy');
    const searchTripInput = document.getElementById('searchTrip');

    let flatpickrInstance;

    // Initialize Flatpickr for custom date range
    function initFlatpickr() {
        if (flatpickrInstance) {
            flatpickrInstance.destroy();
        }
        flatpickrInstance = flatpickr(customDatePicker, {
            mode: "range",
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    filterTrips();
                }
            }
        });
    }

    dateRangeSelect.addEventListener('change', () => {
        if (dateRangeSelect.value === 'custom') {
            customDatePicker.classList.remove('hidden');
            initFlatpickr(); // Re-initialize Flatpickr when custom is selected
        } else {
            customDatePicker.classList.add('hidden');
            if (flatpickrInstance) {
                flatpickrInstance.destroy(); // Destroy Flatpickr instance when not needed
                customDatePicker.value = ''; // Clear custom date picker value
            }
        }
        filterTrips();
    });

    function renderTrips(tripsToDisplay) {
      tripList.innerHTML = '';
      if (tripsToDisplay.length === 0) {
        noTripsMessage.classList.remove('hidden');
      } else {
        noTripsMessage.classList.add('hidden');
        tripsToDisplay.forEach(trip => {
          const tripCard = `
            <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200 cursor-pointer hover:shadow-lg transition-shadow duration-200" onclick="alert('Viewing details for Trip ID: ${trip.id}')">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2">
                <p class="font-semibold text-gray-800">ğŸ“ Pickup: ${trip.pickup} <br> ğŸ Drop: ${trip.drop}</p>
                <p class="text-sm text-gray-600 mt-1 sm:mt-0">ğŸ—“ ${new Date(trip.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} | ğŸ•’ ${trip.time}</p>
              </div>
              <div class="flex items-center justify-between text-sm text-gray-700 mb-2">
                <p>ğŸ’¸ Fare: <span class="font-bold text-emerald-700">â‚¹${trip.fare}</span></p>
                <p>â± Duration: ${trip.duration} mins</p>
              </div>
              <div class="flex items-center justify-between text-sm text-gray-700">
                <p>${getVehicleIcon(trip.vehicle)} Mode: ${trip.vehicle} <span class="ml-2">ğŸ’³ ${trip.payment}</span></p>
                <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs py-1 px-3 rounded-full">View Receipt</button>
              </div>
              ${trip.driver ? <p class="text-xs text-gray-500 mt-2">Driver: ${trip.driver} (${trip.rating}â˜…)</p> : ''}
            </div>
          `;
          tripList.insertAdjacentHTML('beforeend', tripCard);
        });
      }
    }

    function getVehicleIcon(vehicleType) {
      switch (vehicleType) {
        case 'Bike': return 'ğŸ';
        case 'Auto': return 'ğŸ›º';
        case 'Prime Sedan': return 'ğŸš—';
        default: return '';
      }
    }

    function filterTrips() {
      let filtered = [...tripData];
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time for comparison
      const oneWeekAgo = new Date(today);
      oneWeekAgo.setDate(today.getDate() - 7);
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      // Date Range Filter
      const selectedDateRange = dateRangeSelect.value;
      if (selectedDateRange !== 'all') {
        filtered = filtered.filter(trip => {
          const tripDate = new Date(trip.date);
          tripDate.setHours(0, 0, 0, 0);

          if (selectedDateRange === 'today') {
            return tripDate.getTime() === today.getTime();
          } else if (selectedDateRange === 'this_week') {
            return tripDate >= oneWeekAgo && tripDate <= today;
          } else if (selectedDateRange === 'last_30_days') {
            return tripDate >= thirtyDaysAgo && tripDate <= today;
          } else if (selectedDateRange === 'custom') {
            const dateRangeValue = customDatePicker.value;
            if (dateRangeValue) {
                const [startDateStr, endDateStr] = dateRangeValue.split(' to ');
                if (startDateStr && endDateStr) {
                    const startDate = new Date(startDateStr);
                    const endDate = new Date(endDateStr);
                    startDate.setHours(0,0,0,0);
                    endDate.setHours(23,59,59,999); // Include full end day
                    return tripDate >= startDate && tripDate <= endDate;
                }
            }
            return true; // If custom range is selected but not set, show all
          }
          return true;
        });
      }

      // Vehicle Type Filter
      const selectedVehicleType = vehicleTypeSelect.value;
      if (selectedVehicleType !== 'all') {
        filtered = filtered.filter(trip => trip.vehicle === selectedVehicleType);
      }

      // Payment Method Filter
      const selectedPaymentMethod = paymentMethodSelect.value;
      if (selectedPaymentMethod !== 'all') {
        filtered = filtered.filter(trip => trip.payment === selectedPaymentMethod);
      }

      // Search Filter
      const searchTerm = searchTripInput.value.toLowerCase();
      if (searchTerm) {
        filtered = filtered.filter(trip =>
          trip.pickup.toLowerCase().includes(searchTerm) ||
          trip.drop.toLowerCase().includes(searchTerm) ||
          trip.vehicle.toLowerCase().includes(searchTerm) ||
          trip.payment.toLowerCase().includes(searchTerm)
        );
      }

      sortTrips(filtered); // Sort after filtering
    }

    function sortTrips(filteredTrips = null) {
      const tripsToSort = filteredTrips || [...tripData];
      const sortBy = sortBySelect.value;

      tripsToSort.sort((a, b) => {
        if (sortBy === 'date_desc') {
          return new Date(b.date) - new Date(a.date);
        } else if (sortBy === 'date_asc') {
          return new Date(a.date) - new Date(b.date);
        } else if (sortBy === 'fare_desc') {
          return b.fare - a.fare;
        } else if (sortBy === 'fare_asc') {
          return a.fare - b.fare;
        } else if (sortBy === 'duration_desc') {
          return b.duration - a.duration;
        } else if (sortBy === 'duration_asc') {
          return a.duration - b.duration;
        }
        return 0;
      });
      renderTrips(tripsToSort);
    }

    function exportTrips(format) {
      const tripsToExport = Array.from(tripList.children).map(card => {
        // Extract data from the rendered cards for export
        const pickupDropText = card.querySelector('.font-semibold').innerText;
        const [pickup, drop] = pickupDropText.replace('ğŸ“ Pickup: ', '').replace(' ğŸ Drop: ', '').split('\n').map(s => s.trim());
        const dateTimeText = card.querySelector('.text-sm.text-gray-600').innerText;
        const [date, time] = dateTimeText.replace('ğŸ—“ ', '').replace(' | ğŸ•’ ', '').split(' ');
        const fare = card.querySelector('.font-bold.text-emerald-700').innerText.replace('â‚¹', '');
        const duration = card.querySelector('p').nextElementSibling.innerText.replace('â± Duration: ', '').replace(' mins', '');
        const vehiclePaymentText = card.querySelector('.flex.items-center.justify-between.text-sm.text-gray-700 p').innerText;
        const vehicleMatch = vehiclePaymentText.match(/Mode: (.?) \sğŸ’³/);
        const vehicle = vehicleMatch ? vehicleMatch[1].trim() : 'N/A';
        const paymentMatch = vehiclePaymentText.match(/ğŸ’³\s*(.*)/);
        const payment = paymentMatch ? paymentMatch[1].trim() : 'N/A';

        const driverMatch = card.querySelector('.text-xs.text-gray-500');
        const driverInfo = driverMatch ? driverMatch.innerText.replace('Driver: ', '') : 'N/A';
        const driverName = driverInfo !== 'N/A' ? driverInfo.split(' (')[0] : 'N/A';
        const driverRating = driverInfo !== 'N/A' ? driverInfo.split('(')[1].replace('â˜…)', '') : 'N/A';


        return {
          'Trip ID': card.getAttribute('onclick').match(/Trip ID: (\d+)/)[1], // Extract ID from onclick
          'Pickup Location': pickup,
          'Drop Location': drop,
          'Date': date,
          'Time': time,
          'Fare Earned (â‚¹)': fare,
          'Trip Duration (mins)': duration,
          'Vehicle Type': vehicle,
          'Payment Mode': payment,
          'Driver Name': driverName,
          'Driver Rating': driverRating
        };
      });

      if (tripsToExport.length === 0) {
        alert('No trips to export!');
        return;
      }

      if (format === 'csv') {
        const header = Object.keys(tripsToExport[0]).join(',');
        const rows = tripsToExport.map(row => Object.values(row).map(value => "${String(value).replace(/"/g, '""')}").join(',')).join('\n'); // Handle commas in data
        const csvContent = "data:text/csv;charset=utf-8," + header + "\n" + rows;
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "trip_history.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert('Trips exported to CSV!');
      } else if (format === 'pdf') {
        alert('PDF export functionality is not yet implemented. Please use CSV export for now.');
        // For a real application, you would use a library like jsPDF or send data to a backend
      }
    }

    // Initial render when page loads
    document.addEventListener('DOMContentLoaded', () => {
      filterTrips(); // This will apply initial filters and sorting
    });
  </script>
</body>
</html>